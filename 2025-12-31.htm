<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>{{TITLE}}4}4title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js"></script>

<style>
body { font-family: sans-serif; margin: 0; padding: 0; line-height: 1.7; }
header { background: #000; color: #fff; padding: 20px; text-align: center; }
#map { width: 100%; height: 350px; }
.section { padding: 20px; }
h2 { border-left: 5px solid #0078ff; padding-left: 10px; }
.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px; padding: 10px;
}
.gallery img { width: 100%; border-radius: 6px; }
.info-table { width: 100%; border-collapse: collapse; }
.info-table td { padding: 6px 4px; border-bottom: 1px solid #ddd; }
</style>
</head>

<body>

<header>
  <h1>{{TITLE}}</h1>
  <p>{{DATE}} / 距離：<span id="dist">{{DISTANCE}}</span>km /
     獲得標高：<span id="elev">{{ELEVATION}}</span>m</p>
</header>

<div id="map"></div>

<div class="section">
  <h2>走行データ（自動取得）</h2>
  <table class="info-table">
    <tr><td>総距離</td><td><span id="dist2">-</span> km</td></tr>
    <tr><td>累積上昇</td><td><span id="gain">-</span> m</td></tr>
    <tr><td>累積下降</td><td><span id="loss">-</span> m</td></tr>
    <tr><td>最高標高</td><td><span id="maxele">-</span> m</td></tr>
    <tr><td>最低標高</td><td><span id="minele">-</span> m</td></tr>
    <tr><td>開始時刻</td><td><span id="start">-</span></td></tr>
    <tr><td>終了時刻</td><td><span id="end">-</span></td></tr>
    <tr><td>総時間</td><td><span id="totaltime">-</span></td></tr>
    <tr><td>移動時間</td><td><span id="movingtime">-</span></td></tr>
    <tr><td>平均速度</td><td><span id="avgspeed">-</span> km/h</td></tr>
    <tr><td>移動平均速度</td><td><span id="movingspeed">-</span> km/h</td></tr>
    <tr><td>開始地点</td><td><span id="startpt">-</span></td></tr>
    <tr><td>終了地点</td><td><span id="endpt">-</span></td></tr>
    <tr><td>標高データ数</td><td><span id="elecount">-</span></td></tr>
    <tr><td>速度データ数</td><td><span id="speedcount">-</span></td></tr>
  </table>
</div>

<div class="section">
  <h2>ルート概要</h2>
  <p>{{DESCRIPTION}}</p>
</div>

<div class="section">
  <h2>写真ギャラリー</h2>
  <div class="gallery">
    {{GALLERY}}
  </div>
</div>

<div class="section">
  <h2>補給ポイント</h2>
  <ul>{{FOOD}}</ul>
</div>

<div class="section">
  <h2>おすすめ装備</h2>
  <ul>
    <li><a href="{{AFFILIATE1}}">ライト（Amazon）</a></li>
    <li><a href="{{AFFILIATE2}}">補給食（Amazon）</a></li>
    <li><a href="{{AFFILIATE3}}">タイヤ（Amazon）</a></li>
  </ul>
</div>

<script>
// ① map を作成
var map = L.map("map").setView([34.6, 135.5], 12);

// ② タイルレイヤー
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

// ③ GPX 読み込み
var gpx = new L.GPX("2025-12-31.gpx", {
  async: true,
  polyline_options: { color: "red", weight: 4, opacity: 0.8 }
})
.on("loaded", function(e) {
  map.fitBounds(e.target.getBounds());

  // 基本データ
  var dist = (e.target.get_distance() / 1000).toFixed(1);
  var gain = Math.round(e.target.get_elevation_gain());
  var loss = Math.round(e.target.get_elevation_loss());
  var maxele = Math.round(e.target.get_elevation_max());
  var minele = Math.round(e.target.get_elevation_min());

  // 時間
  var start = e.target.get_start_time();
  var end = e.target.get_end_time();
  var total = e.target.get_total_time();
  var moving = e.target.get_moving_time();

  // 速度データ（配列）
  var speeds = e.target.get_speed_data();
  var avg = 0, movingAvg = 0;

  if (speeds.length > 0) {
    var sum = speeds.reduce((a, b) => a + b, 0);
    avg = (sum / speeds.length) * 3.6;

    var movingSpeeds = speeds.filter(v => v > 0.5);
    if (movingSpeeds.length > 0) {
      var sum2 = movingSpeeds.reduce((a, b) => a + b, 0);
      movingAvg = (sum2 / movingSpeeds.length) * 3.6;
    }
  }

  // 座標（get_starting_point は使えない）
  var latlngs = e.target.get_latlngs();
  var startpt = latlngs[0];
  var endpt   = latlngs[latlngs.length - 1];

  // 配列数
  var elecount = e.target.get_elevation_data().length;
  var speedcount = speeds.length;

  // HTML 反映
  document.getElementById("dist").innerText = dist;
  document.getElementById("elev").innerText = gain;

  document.getElementById("dist2").innerText = dist;
  document.getElementById("gain").innerText = gain;
  document.getElementById("loss").innerText = loss;
  document.getElementById("maxele").innerText = maxele;
  document.getElementById("minele").innerText = minele;

  document.getElementById("start").innerText = start;
  document.getElementById("end").innerText = end;
  document.getElementById("totaltime").innerText = (total/3600).toFixed(1) + " h";
  document.getElementById("movingtime").innerText = (moving/3600).toFixed(1) + " h";

  document.getElementById("avgspeed").innerText = avg.toFixed(1);
  document.getElementById("movingspeed").innerText = movingAvg.toFixed(1);

  document.getElementById("startpt").innerText = startpt.lat + ", " + startpt.lng;
  document.getElementById("endpt").innerText = endpt.lat + ", " + endpt.lng;

  document.getElementById("elecount").innerText = elecount;
  document.getElementById("speedcount").innerText = speedcount;
})
.addTo(map);
</script>

</body>
</html>
