<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>{{TITLE}}14</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: sans-serif; margin: 0; padding: 0; line-height: 1.7; }
header { background: #000; color: #fff; padding: 20px; text-align: center; }
#map { width: 100%; height: 350px; }
.section { padding: 20px; }
h2 { border-left: 5px solid #0078ff; padding-left: 10px; }
.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px; padding: 10px;
}
.gallery img { width: 100%; border-radius: 6px; }
.info-table { width: 100%; border-collapse: collapse; }
.info-table td { padding: 6px 4px; border-bottom: 1px solid #ddd; }
#elevationChart { width: 100%; height: 200px !important; }
</style>
</head>

<body>

<header>
  <h1>{{TITLE}}</h1>
  <p>{{DATE}} / 距離：<span id="dist">{{DISTANCE}}</span>km /
     獲得標高：<span id="elev">{{ELEVATION}}</span>m</p>
</header>

<div id="map"></div>

<div class="section">
  <h2>走行データ（自動取得）</h2>
  <table class="info-table">
    <tr><td>総距離</td><td><span id="dist2">-</span> km</td></tr>
    <tr><td>累積上昇</td><td><span id="gain">-</span> m</td></tr>
    <tr><td>累積下降</td><td><span id="loss">-</span> m</td></tr>
    <tr><td>最高標高</td><td><span id="maxele">-</span> m</td></tr>
    <tr><td>最低標高</td><td><span id="minele">-</span> m</td></tr>
    <tr><td>開始時刻</td><td><span id="start">-</span></td></tr>
    <tr><td>終了時刻</td><td><span id="end">-</span></td></tr>
    <tr><td>総時間</td><td><span id="totaltime">-</span></td></tr>
    <tr><td>移動時間</td><td><span id="movingtime">-</span></td></tr>
    <tr><td>平均速度</td><td><span id="avgspeed">-</span> km/h</td></tr>
    <tr><td>標高データ数</td><td><span id="elecount">-</span></td></tr>
    <tr><td>速度データ数</td><td><span id="speedcount">-</span></td></tr>
  </table>
</div>

<div class="section">
  <h2>標高グラフ</h2>
  <canvas id="elevationChart"></canvas>
</div>

<script>
// ------------------------------
// 1. 地図作成
// ------------------------------
var map = L.map("map").setView([34.6, 135.5], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

// ------------------------------
// 2. GPX 読み込み
// ------------------------------
var gpx = new L.GPX("2025-12-31.gpx", {
  async: true,
  polyline_options: { color: "red", weight: 4, opacity: 0.8 }
})

// ------------------------------
// 3. 統計値（loaded）
// ------------------------------
.on("loaded", function(e) {

  var dist = (e.target.get_distance() / 1000).toFixed(2);
  var gain = Math.round(e.target.get_elevation_gain());
  var loss = Math.round(e.target.get_elevation_loss());
  var maxele = Math.round(e.target.get_elevation_max());
  var minele = Math.round(e.target.get_elevation_min());

  var start = e.target.get_start_time();
  var end = e.target.get_end_time();
  var total = e.target.get_total_time();
  var moving = e.target.get_moving_time();

  var speeds = e.target.get_speed_data();
  var avg = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length)*3.6 : 0;

  var eleData = e.target.get_elevation_data();

  document.getElementById("dist").innerText = dist;
  document.getElementById("elev").innerText = gain;

  document.getElementById("dist2").innerText = dist;
  document.getElementById("gain").innerText = gain;
  document.getElementById("loss").innerText = loss;
  document.getElementById("maxele").innerText = maxele;
  document.getElementById("minele").innerText = minele;

  document.getElementById("start").innerText = start;
  document.getElementById("end").innerText = end;
  document.getElementById("totaltime").innerText = (total/3600).toFixed(1) + " h";
  document.getElementById("movingtime").innerText = (moving/3600).toFixed(1) + " h";

  document.getElementById("avgspeed").innerText = avg.toFixed(1);

  document.getElementById("elecount").innerText = eleData.length;
  document.getElementById("speedcount").innerText = speeds.length;
})

// ------------------------------
// 4. trkpt & グラフ（addline）
// ------------------------------
.on("addline", function(e) {

  // ★ _info.gpx が完成するまで待つ
  function waitForInfo(callback) {
    const timer = setInterval(() => {
      if (e.target._info && e.target._info.gpx && e.target._info.gpx.trk) {
        clearInterval(timer);
        callback(e.target._info.gpx.trk);
      }
    }, 50);
  }

  waitForInfo(function(trk) {

    var pts = trk[0].trkseg[0].trkpt;

    // マーカー
    var hoverMarker = L.circleMarker([0,0], {
      radius: 6,
      color: "red",
      fillColor: "yellow",
      fillOpacity: 1
    }).addTo(map);

    function moveMarkerToPoint(i) {
      if (i < 0 || i >= pts.length) return;
      hoverMarker.setLatLng([pts[i].lat, pts[i].lon]);
    }

    // 標高データ
    var eleData = e.target.get_elevation_data();

    // グラフ描画
    var ctx = document.getElementById("elevationChart").getContext("2d");

    new Chart(ctx, {
      type: "line",
      data: {
        labels: eleData.map((v, i) => i),
        datasets: [{
          label: "標高 (m)",
          data: eleData,
          borderColor: "#0078ff",
          backgroundColor: "rgba(0,120,255,0.2)",
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: false },
          y: { beginAtZero: false }
        },
        interaction: {
          mode: "index",
          intersect: false
        },
        onHover: function(evt, active) {
          if (active.length > 0) {
            moveMarkerToPoint(active[0].index);
          }
        }
      }
    });

    // 経路の範囲に合わせる
    map.fitBounds(e.target.getBounds());

  });

})

.addTo(map);
</script>

</body>
</html>
